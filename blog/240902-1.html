<!DOCTYPE html><html lang="en" class="text-black bg-white dark:text-white dark:bg-black __variable_ac79ff __variable_8a4d12"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/ec1a1eae803b668e-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/f980ec13b5b5e554.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="/images/blog/240902-1/wireguard_8070_8878.png"/><link rel="stylesheet" href="/_next/static/css/5c2e7a9dbf5cdffa.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-a6c7e66d007cbd0c.js"/><script src="/_next/static/chunks/3471c0f1-010786d28242dc9d.js" async=""></script><script src="/_next/static/chunks/6-82f781cfdf3075d7.js" async=""></script><script src="/_next/static/chunks/main-app-772f677cdc9845ce.js" async=""></script><script src="/_next/static/chunks/951-68001eacaacb5ddd.js" async=""></script><script src="/_next/static/chunks/app/blog/%5Bslug%5D/page-68a8741e3efe855c.js" async=""></script><title>Remote Server behind CGNAT using Wireguard | Brian Phan</title><meta name="description" content="This is my portfolio."/><meta name="robots" content="index, follow"/><meta name="googlebot" content="index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"/><meta property="og:title" content="My Portfolio"/><meta property="og:description" content="This is my portfolio."/><meta property="og:url" content="https://bachsofttrick.github.io"/><meta property="og:site_name" content="My Portfolio"/><meta property="og:locale" content="en_US"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="My Portfolio"/><meta name="twitter:description" content="This is my portfolio."/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="antialiased max-w-4xl mx-4 mt-8 lg:mx-auto"><main class="flex-auto min-w-0 mt-6 flex flex-col px-2 md:px-0"><aside class="-ml-[8px] mb-16 tracking-tight"><div class="lg:sticky lg:top-20"><nav class="flex flex-row items-start relative px-0 pb-0 fade md:overflow-auto scroll-pr-6 md:relative" id="nav"><div class="flex flex-row space-x-0 pr-10"><a class="transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1" href="/">home</a><a class="transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1" href="/about">about</a><a class="transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1" href="/blog">blog</a></div></nav></div></aside><section><h1 class="title font-semibold text-2xl tracking-tighter">Remote Server behind CGNAT using Wireguard</h1><div class="flex justify-between items-center mt-2 mb-8 text-sm"><p class="text-sm text-neutral-600 dark:text-neutral-400">Sep 2, 2024</p></div><article class="prose"><p>I keep delaying this post because it&#x27;s something that has already been
done, and I don&#x27;t want to repeat myself. But Jeff Geerling, a Youtuber I
follow, posted a <a target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/watch?v=5NJ6V8i1Xd8">video</a>
about deploying your own VPN to access your server from a remote
location, and I feel like I must write my own experience on the matter.</p>
<h4 id="the-differences-in-my-approach"><a href="#the-differences-in-my-approach" class="anchor"></a>The differences in my approach</h4>
<p>According to Mr. Geerling, he had a public IP (though not static) and
pointed his domain to this IP to connect to his network using Wireguard
installed by PiVPN. I do not have such luxury, as my public IP is
10.x.x.x through PPPoE to my ISP, Viettel, so using his way was out of
the question. I am stuck in a situation known as CGNAT. What&#x27;s more, he
exposed ALL his network out, which, to each of their own, is quite
dangerous as the VPN can be used as an attack vector to your own
network. I did a similar thing while creating my own VOIP service using
Asterisk, but it only lasted a day, and I quickly closed it due to the
danger behind it. PiVPN, the tool he used, is quite fascinating and I
will look into it in the future. But back when I built my VPN, it was on
a virtual server, and I built it manually. I didn&#x27;t know any automated
tool like his, I just followed some guides from DigitalOcean to set up
Wireguard, along with fail2ban, ssh. In fact, the reason I chose
Wireguard was that it was easier to set up. OpenVPN has a lot of moving
parts needed to run, while Wireguard only requires a pair of keys.
Granted, there are
<a target="_blank" rel="noopener noreferrer" href="https://github.com/angristan/openvpn-install">scripts</a> that help
install OpenVPN, but the performance is OpenVPN&#x27;s Achilles&#x27;s heel. I
only have 1 vCPU, so performance is kind of a big deal. Lastly, his
video mentioned &quot;a little extra security on public Wifi&quot; and &quot;bypass
content restriction&quot;. While my VPN can&#x27;t bypass any content restriction,
it can provide encryption for my traffic on public Wifi, in addition to
providing its own DNS server to speed up DNS query.</p>
<h4 id="cgnat-carrier-grade-network-address-translation"><a href="#cgnat-carrier-grade-network-address-translation" class="anchor"></a>CGNAT (carrier-grade network address translation)</h4>
<p>A blog <a target="_blank" rel="noopener noreferrer" href="https://www.draytek.co.uk/information/blog/what-is-cgnat">post</a>
on Draytek explains this well, but to quote from a
<a target="_blank" rel="noopener noreferrer" href="https://www.reddit.com/r/HomeNetworking/comments/hi2sde/i_just_learned_my_internet_connection_is_cgnat_is/">reddit</a>
comment as a short version: &quot;CGNAT means your ISP doesn&#x27;t have enough
public IPv4 addresses to assign one to each user. So they are
essentially doing to you what your home router does to the Internet by
giving you a NAT&#x27;ed IP address. Yes, that means you can&#x27;t run your own
servers or forward traffic at home&quot;. My situation may not technically be
CGNAT, could be simply double NAT from my end and my ISP&#x27;s, because my
&quot;public&quot; IP is not in the CGNAT address block, which is usually from
100.64.0.0 to 100.127.255.255, is 10.x.x.x. I first noticed this
phenomenon in 2014, when I installed fiber. Though back then I didn&#x27;t
know how to bridge the ISP router to my TP-Link router, I knew of double
NAT and opened similar port on both routers to torrent. However, I
checked on <a target="_blank" rel="noopener noreferrer" href="https://canyouseeme.org/">https://canyouseeme.org/</a> and they couldn&#x27;t see the open
port. The torrent could still download, but it couldn&#x27;t upload. It was
strange, because before that, I could see the open port when I was still
on ADSL (also double NAT). It was my biggest achievement back in 8^th^
grade, to open port and torrent, or host my own radio using Windows
Media Encoder. The second biggest was getting 3D games to run on my
Pentium 4 computer.</p>
<h4 id="setting-up-virtual-server"><a href="#setting-up-virtual-server" class="anchor"></a>Setting up virtual server</h4>
<p>There are a lot of options when choosing a virtual server provider. I
chose Viettel IDC because it was the closest to home, and I also use
their fiber service. I bought 1 vCore with 1GB RAM, 20GB SSD, 300 Mbps
unlimited bandwidth. I chose Ubuntu Server as the base OS, because I&#x27;m
used to Debian-based OS. I guess the way to choose your preferences
works the same in other providers, whether AWS, GCP, Linode...</p>
<p>Some steps I performed before setting up WIreguard:</p>
<p>- Install ssh to have remote access, instead of using console from
browser. Change ssh port, only allow access with key</p>
<p>- Configure firewall using
<a target="_blank" rel="noopener noreferrer" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-20-04">ufw</a>:
Deny all incoming, allow ssh port, Wireguard port</p>
<p>- Install
<a target="_blank" rel="noopener noreferrer" href="https://www.digitalocean.com/community/tutorials/how-fail2ban-works-to-protect-services-on-a-linux-server">fail2ban</a>
to limit amount of login attempts</p>
<h4 id="setting-up-wireguard"><a href="#setting-up-wireguard" class="anchor"></a>Setting up Wireguard</h4>
<p>I followed this
<a target="_blank" rel="noopener noreferrer" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04">guide</a>
on how to set up Wireguard Server. First, I generated 2 pairs of keys,
one for the server, one for the client using the commands:</p>
<p><em>wg genkey | sudo tee /etc/wireguard/private.key</em></p>
<p><em>sudo cat /etc/wireguard/private.key | wg pubkey | sudo tee
/etc/wireguard/public.key</em></p>
<p>Following that, I had to choose a subnet. Since 192.168.0.x, 1.x are all
too common, I chose anything from 2.x and up. After that, I went to
<em>/etc/wireguard/</em>. I created a config file for my VPN, <em>wg0.conf</em></p>
<p><em>[Interface]</em></p>
<p><em>Address = 192.168.13.1/24</em></p>
<p><em>PostUp = ufw allow 51820/udp</em></p>
<p><em>PostUp = ufw route allow in on wg0</em></p>
<p><em>PreDown = ufw delete allow 51820/udp</em></p>
<p><em>PreDown = ufw route delete allow in on wg0</em></p>
<p><em>ListenPort = 51820</em></p>
<p><em>PrivateKey = &lt;server private key here&gt;</em></p>
<p><em>[Peer]</em></p>
<p><em>PublicKey = &lt;client public key here&gt;</em></p>
<p><em>AllowedIPs = 192.168.13.2/32</em></p>
<p><em>[Interface]</em> is configurations for your own VPN interface, whether
it&#x27;s a server or a client. <em>PostUp</em> and <em>PreDown</em> are commands to run
<em>after</em> turning on the VPN server and <em>before</em>
shutting down server, respectively. I set up a bunch of commands that
open port, allow traffic running inside VPN and vice versa when turning
off server. <em>[Peer]</em> are configurations for clients that will connect
to the server. Each <em>[Peer]</em> adds another client to the server.
<em>AllowedIPs</em> is where you type in the client&#x27;s VPN IP address. If the
client also acts as a router to another subnet, for instance,
192.168.0.x, you can add <em>192.168.0.0/24</em> and you can access that subnet
from the VPN.</p>
<p>On my home server, not the virtual one. I also created a config file in
<em>/etc/wireguard/wg0.conf</em>:</p>
<p><em>[Interface]</em></p>
<p><em>PrivateKey = &lt;client private key here&gt;</em></p>
<p><em>Address = 192.168.13.2/24</em></p>
<p><em>DNS = 8.8.8.8</em></p>
<p><em>[Peer]</em></p>
<p><em>PublicKey = &lt;server public key here&gt;</em></p>
<p><em>AllowedIPs = 192.168.13.0/24</em></p>
<p><em>Endpoint = &lt;server real IP&gt;:51820</em></p>
<p><em>PersistentKeepalive = 25</em></p>
<p><em>[Peer]</em> here means something different. For a client to connect to a
server, it only needs 1 peer. For <em>Endpoint</em>, you need to pinpoint the
virtual server&#x27;s IP address. <em>PersistentKeepalive</em> is necessary to keep
the connection up, as we are running essentially a tunnel from the
virtual server to the real one. If the client isn&#x27;t a server, that part
won&#x27;t be needed.</p>
<p>On both servers, I typed in <em>wg-quick up wg0</em>. I pinged from each side
with the other&#x27;s IP address and it worked.</p>
<p><p class="flex justify-center"><img src="/images/blog/240902-1/wireguard_8070_8878.png" alt=""/></p></p>
<p>References:</p>
<p>- <a target="_blank" rel="noopener noreferrer" href="https://www.jeffgeerling.com/blog/2023/build-your-own-private-wireguard-vpn-pivpn">Jeef Geerling - Build your own private WireGuard VPN with
PiVPN</a></p>
<p>- <a target="_blank" rel="noopener noreferrer" href="https://blog.apnic.net/2021/06/17/how-a-small-free-ip-tool-survived/">Information about icanhazip.com, you can use ident.me
instead</a></p>
<p>- <a target="_blank" rel="noopener noreferrer" href="https://www.reddit.com/r/explainlikeimfive/comments/1wqc30/eli5_how_does_nat_network_address_translation_work/">ELI5: How does NAT (Network Address Translation)
work</a></p></article></section><footer class="mb-16"><ul class="font-sm mt-8 flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300"><li><p class=" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100">Corvallis, Oregon, USA</p></li><li><p class=" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100">Phone: 541-360-9231</p></li></ul><ul class="font-sm flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300"><li><a class="flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100" rel="noopener noreferrer" target="_blank" href="https://github.com/bachsofttrick"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z" fill="currentColor"></path></svg><p class="ml-2 h-7">github</p></a></li><li><a class="flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100" rel="noopener noreferrer" target="_blank" href="https://github.com/bachsofttrick/bachsofttrick.github.io"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z" fill="currentColor"></path></svg><p class="ml-2 h-7">view source</p></a></li><li><a class="flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100" rel="noopener noreferrer" target="_blank" href="https://linkedin.com/in/brian-phan-58530b1b0/"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z" fill="currentColor"></path></svg><p class="ml-2 h-7">linkedin</p></a></li><li><a class="flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100" rel="noopener noreferrer" target="_blank" href="mailto:xuanbach1307@gmail.com"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z" fill="currentColor"></path></svg><p class="ml-2 h-7">email</p></a></li></ul><p class="mt-8 text-neutral-600 dark:text-neutral-300">2024</p></footer></main><script src="/_next/static/chunks/webpack-a6c7e66d007cbd0c.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/ec1a1eae803b668e-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/f980ec13b5b5e554.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/css/5c2e7a9dbf5cdffa.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"4:I[4163,[],\"\"]\n7:I[5505,[],\"\"]\n9:I[8694,[],\"\"]\na:I[7951,[\"951\",\"static/chunks/951-68001eacaacb5ddd.js\",\"308\",\"static/chunks/app/blog/%5Bslug%5D/page-68a8741e3efe855c.js\"],\"\"]\nc:I[8233,[],\"\"]\n8:[\"slug\",\"240902-1\",\"d\"]\nd:[]\n"])</script><script>self.__next_f.push([1,"0:[\"$\",\"$L4\",null,{\"buildId\":\"brBpt6Vv2S2QjIHANimmv\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"blog\",\"240902-1\"],\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"240902-1\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"240902-1\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"240902-1\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L5\",[\"$\",\"section\",null,{\"children\":[[\"$\",\"h1\",null,{\"className\":\"title font-semibold text-2xl tracking-tighter\",\"children\":\"Remote Server behind CGNAT using Wireguard\"}],[\"$\",\"div\",null,{\"className\":\"flex justify-between items-center mt-2 mb-8 text-sm\",\"children\":[\"$\",\"p\",null,{\"className\":\"text-sm text-neutral-600 dark:text-neutral-400\",\"children\":\"Sep 2, 2024\"}]}],[\"$\",\"article\",null,{\"className\":\"prose\",\"children\":\"$L6\"}]]}],null],null],null]},[null,[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$8\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/5c2e7a9dbf5cdffa.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"text-black bg-white dark:text-white dark:bg-black __variable_ac79ff __variable_8a4d12\",\"children\":[\"$\",\"body\",null,{\"className\":\"antialiased max-w-4xl mx-4 mt-8 lg:mx-auto\",\"children\":[\"$\",\"main\",null,{\"className\":\"flex-auto min-w-0 mt-6 flex flex-col px-2 md:px-0\",\"children\":[[\"$\",\"aside\",null,{\"className\":\"-ml-[8px] mb-16 tracking-tight\",\"children\":[\"$\",\"div\",null,{\"className\":\"lg:sticky lg:top-20\",\"children\":[\"$\",\"nav\",null,{\"className\":\"flex flex-row items-start relative px-0 pb-0 fade md:overflow-auto scroll-pr-6 md:relative\",\"id\":\"nav\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex flex-row space-x-0 pr-10\",\"children\":[[\"$\",\"$La\",\"/\",{\"href\":\"/\",\"className\":\"transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1\",\"children\":\"home\"}],[\"$\",\"$La\",\"/about\",{\"href\":\"/about\",\"className\":\"transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1\",\"children\":\"about\"}],[\"$\",\"$La\",\"/blog\",{\"href\":\"/blog\",\"className\":\"transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1\",\"children\":\"blog\"}]]}]}]}]}],[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"section\",null,{\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-8 text-2xl font-semibold tracking-tighter\",\"children\":\"404 - Page Not Found\"}],[\"$\",\"p\",null,{\"className\":\"mb-4\",\"children\":\"The page you are looking for does not exist.\"}]]}],\"notFoundStyles\":[]}],[\"$\",\"footer\",null,{\"className\":\"mb-16\",\"children\":[[\"$\",\"ul\",null,{\"className\":\"font-sm mt-8 flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300\",\"children\":[[\"$\",\"li\",null,{\"children\":[\"$undefined\",[\"$\",\"p\",null,{\"className\":\" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"children\":\"Corvallis, Oregon, USA\"}]]}],[\"$\",\"li\",null,{\"children\":[\"$undefined\",[\"$\",\"p\",null,{\"className\":\" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"children\":\"Phone: 541-360-9231\"}]]}]]}],[\"$\",\"ul\",null,{\"className\":\"font-sm flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300\",\"children\":[[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"className\":\"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"rel\":\"noopener noreferrer\",\"target\":\"_blank\",\"href\":\"https://github.com/bachsofttrick\",\"children\":[[\"$\",\"svg\",null,{\"width\":\"12\",\"height\":\"12\",\"viewBox\":\"0 0 12 12\",\"fill\":\"none\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z\",\"fill\":\"currentColor\"}]}],[\"$\",\"p\",null,{\"className\":\"ml-2 h-7\",\"children\":\"github\"}]]}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"className\":\"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"rel\":\"noopener noreferrer\",\"target\":\"_blank\",\"href\":\"https://github.com/bachsofttrick/bachsofttrick.github.io\",\"children\":[[\"$\",\"svg\",null,{\"width\":\"12\",\"height\":\"12\",\"viewBox\":\"0 0 12 12\",\"fill\":\"none\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z\",\"fill\":\"currentColor\"}]}],[\"$\",\"p\",null,{\"className\":\"ml-2 h-7\",\"children\":\"view source\"}]]}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"className\":\"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"rel\":\"noopener noreferrer\",\"target\":\"_blank\",\"href\":\"https://linkedin.com/in/brian-phan-58530b1b0/\",\"children\":[[\"$\",\"svg\",null,{\"width\":\"12\",\"height\":\"12\",\"viewBox\":\"0 0 12 12\",\"fill\":\"none\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z\",\"fill\":\"currentColor\"}]}],[\"$\",\"p\",null,{\"className\":\"ml-2 h-7\",\"children\":\"linkedin\"}]]}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"className\":\"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"rel\":\"noopener noreferrer\",\"target\":\"_blank\",\"href\":\"mailto:xuanbach1307@gmail.com\",\"children\":[[\"$\",\"svg\",null,{\"width\":\"12\",\"height\":\"12\",\"viewBox\":\"0 0 12 12\",\"fill\":\"none\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z\",\"fill\":\"currentColor\"}]}],[\"$\",\"p\",null,{\"className\":\"ml-2 h-7\",\"children\":\"email\"}]]}]}]]}],[\"$\",\"p\",null,{\"className\":\"mt-8 text-neutral-600 dark:text-neutral-300\",\"children\":2024}]]}]]}]}]}]],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$Lb\"],\"globalErrorComponent\":\"$c\",\"missingSlots\":\"$Wd\"}]\n"])</script><script>self.__next_f.push([1,"e:T46e,According to Mr. Geerling, he had a public IP (though not static) and\npointed his domain to this IP to connect to his network using Wireguard\ninstalled by PiVPN. I do not have such luxury, as my public IP is\n10.x.x.x through PPPoE to my ISP, Viettel, so using his way was out of\nthe question. I am stuck in a situation known as CGNAT. What's more, he\nexposed ALL his network out, which, to each of their own, is quite\ndangerous as the VPN can be used as an attack vector to your own\nnetwork. I did a similar thing while creating my own VOIP service using\nAsterisk, but it only lasted a day, and I quickly closed it due to the\ndanger behind it. PiVPN, the tool he used, is quite fascinating and I\nwill look into it in the future. But back when I built my VPN, it was on\na virtual server, and I built it manually. I didn't know any automated\ntool like his, I just followed some guides from DigitalOcean to set up\nWireguard, along with fail2ban, ssh. In fact, the reason I chose\nWireguard was that it was easier to set up. OpenVPN has a lot of moving\nparts needed to run, while Wireguard only requires a pair of keys.\nGranted, there are\n"])</script><script>self.__next_f.push([1,"6:[[\"$\",\"p\",null,{\"children\":[\"I keep delaying this post because it's something that has already been\\ndone, and I don't want to repeat myself. But Jeff Geerling, a Youtuber I\\nfollow, posted a \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.youtube.com/watch?v=5NJ6V8i1Xd8\",\"children\":\"video\"}],\"\\nabout deploying your own VPN to access your server from a remote\\nlocation, and I feel like I must write my own experience on the matter.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"id\":\"the-differences-in-my-approach\",\"className\":\"$undefined\",\"children\":[[[\"$\",\"a\",\"link-the-differences-in-my-approach\",{\"href\":\"#the-differences-in-my-approach\",\"className\":\"anchor\"}]],\"The differences in my approach\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$e\",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://github.com/angristan/openvpn-install\",\"children\":\"scripts\"}],\" that help\\ninstall OpenVPN, but the performance is OpenVPN's Achilles's heel. I\\nonly have 1 vCPU, so performance is kind of a big deal. Lastly, his\\nvideo mentioned \\\"a little extra security on public Wifi\\\" and \\\"bypass\\ncontent restriction\\\". While my VPN can't bypass any content restriction,\\nit can provide encryption for my traffic on public Wifi, in addition to\\nproviding its own DNS server to speed up DNS query.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"id\":\"cgnat-carrier-grade-network-address-translation\",\"className\":\"$undefined\",\"children\":[[[\"$\",\"a\",\"link-cgnat-carrier-grade-network-address-translation\",{\"href\":\"#cgnat-carrier-grade-network-address-translation\",\"className\":\"anchor\"}]],\"CGNAT (carrier-grade network address translation)\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"A blog \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.draytek.co.uk/information/blog/what-is-cgnat\",\"children\":\"post\"}],\"\\non Draytek explains this well, but to quote from a\\n\",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.reddit.com/r/HomeNetworking/comments/hi2sde/i_just_learned_my_internet_connection_is_cgnat_is/\",\"children\":\"reddit\"}],\"\\ncomment as a short version: \\\"CGNAT means your ISP doesn't have enough\\npublic IPv4 addresses to assign one to each user. So they are\\nessentially doing to you what your home router does to the Internet by\\ngiving you a NAT'ed IP address. Yes, that means you can't run your own\\nservers or forward traffic at home\\\". My situation may not technically be\\nCGNAT, could be simply double NAT from my end and my ISP's, because my\\n\\\"public\\\" IP is not in the CGNAT address block, which is usually from\\n100.64.0.0 to 100.127.255.255, is 10.x.x.x. I first noticed this\\nphenomenon in 2014, when I installed fiber. Though back then I didn't\\nknow how to bridge the ISP router to my TP-Link router, I knew of double\\nNAT and opened similar port on both routers to torrent. However, I\\nchecked on \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://canyouseeme.org/\",\"children\":\"https://canyouseeme.org/\"}],\" and they couldn't see the open\\nport. The torrent could still download, but it couldn't upload. It was\\nstrange, because before that, I could see the open port when I was still\\non ADSL (also double NAT). It was my biggest achievement back in 8^th^\\ngrade, to open port and torrent, or host my own radio using Windows\\nMedia Encoder. The second biggest was getting 3D games to run on my\\nPentium 4 computer.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"id\":\"setting-up-virtual-server\",\"className\":\"$undefined\",\"children\":[[[\"$\",\"a\",\"link-setting-up-virtual-server\",{\"href\":\"#setting-up-virtual-server\",\"className\":\"anchor\"}]],\"Setting up virtual server\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"There are a lot of options when choosing a virtual server provider. I\\nchose Viettel IDC because it was the closest to home, and I also use\\ntheir fiber service. I bought 1 vCore with 1GB RAM, 20GB SSD, 300 Mbps\\nunlimited bandwidth. I chose Ubuntu Server as the base OS, because I'm\\nused to Debian-based OS. I guess the way to choose your preferences\\nworks the same in other providers, whether AWS, GCP, Linode...\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Some steps I performed before setting up WIreguard:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"- Install ssh to have remote access, instead of using console from\\nbrowser. Change ssh port, only allow access with key\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- Configure firewall using\\n\",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-20-04\",\"children\":\"ufw\"}],\":\\nDeny all incoming, allow ssh port, Wireguard port\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- Install\\n\",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.digitalocean.com/community/tutorials/how-fail2ban-works-to-protect-services-on-a-linux-server\",\"children\":\"fail2ban\"}],\"\\nto limit amount of login attempts\"]}],\"\\n\",[\"$\",\"h4\",null,{\"id\":\"setting-up-wireguard\",\"className\":\"$undefined\",\"children\":[[[\"$\",\"a\",\"link-setting-up-wireguard\",{\"href\":\"#setting-up-wireguard\",\"className\":\"anchor\"}]],\"Setting up Wireguard\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"I followed this\\n\",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04\",\"children\":\"guide\"}],\"\\non how to set up Wireguard Server. First, I generated 2 pairs of keys,\\none for the server, one for the client using the commands:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"wg genkey | sudo tee /etc/wireguard/private.key\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"sudo cat /etc/wireguard/private.key | wg pubkey | sudo tee\\n/etc/wireguard/public.key\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Following that, I had to choose a subnet. Since 192.168.0.x, 1.x are all\\ntoo common, I chose anything from 2.x and up. After that, I went to\\n\",[\"$\",\"em\",null,{\"children\":\"/etc/wireguard/\"}],\". I created a config file for my VPN, \",[\"$\",\"em\",null,{\"children\":\"wg0.conf\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"[Interface]\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"Address = 192.168.13.1/24\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PostUp = ufw allow 51820/udp\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PostUp = ufw route allow in on wg0\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PreDown = ufw delete allow 51820/udp\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PreDown = ufw route delete allow in on wg0\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"ListenPort = 51820\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PrivateKey = \u003cserver private key here\u003e\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"[Peer]\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PublicKey = \u003cclient public key here\u003e\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"AllowedIPs = 192.168.13.2/32\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"em\",null,{\"children\":\"[Interface]\"}],\" is configurations for your own VPN interface, whether\\nit's a server or a client. \",[\"$\",\"em\",null,{\"children\":\"PostUp\"}],\" and \",[\"$\",\"em\",null,{\"children\":\"PreDown\"}],\" are commands to run\\n\",[\"$\",\"em\",null,{\"children\":\"after\"}],\" turning on the VPN server and \",[\"$\",\"em\",null,{\"children\":\"before\"}],\"\\nshutting down server, respectively. I set up a bunch of commands that\\nopen port, allow traffic running inside VPN and vice versa when turning\\noff server. \",[\"$\",\"em\",null,{\"children\":\"[Peer]\"}],\" are configurations for clients that will connect\\nto the server. Each \",[\"$\",\"em\",null,{\"children\":\"[Peer]\"}],\" adds another client to the server.\\n\",[\"$\",\"em\",null,{\"children\":\"AllowedIPs\"}],\" is where you type in the client's VPN IP address. If the\\nclient also acts as a router to another subnet, for instance,\\n192.168.0.x, you can add \",[\"$\",\"em\",null,{\"children\":\"192.168.0.0/24\"}],\" and you can access that subnet\\nfrom the VPN.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"On my home server, not the virtual one. I also created a config file in\\n\",[\"$\",\"em\",null,{\"children\":\"/etc/wireguard/wg0.conf\"}],\":\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"[Interface]\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PrivateKey = \u003cclient private key here\u003e\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"Address = 192.168.13.2/24\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"DNS = 8.8.8.8\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"[Peer]\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PublicKey = \u003cserver public key here\u003e\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"AllowedIPs = 192.168.13.0/24\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"Endpoint = \u003cserver real IP\u003e:51820\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PersistentKeepalive = 25\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"em\",null,{\"children\":\"[Peer]\"}],\" here means something different. For a client to connect to a\\nserver, it only needs 1 peer. For \",[\"$\",\"em\",null,{\"children\":\"Endpoint\"}],\", you need to pinpoint the\\nvirtual server's IP address. \",[\"$\",\"em\",null,{\"children\":\"PersistentKeepalive\"}],\" is necessary to keep\\nthe connection up, as we are running essentially a tunnel from the\\nvirtual server to the real one. If the client isn't a server, that part\\nwon't be needed.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"On both servers, I typed in \",[\"$\",\"em\",null,{\"children\":\"wg-quick up wg0\"}],\". I pinged from each side\\nwith the other's IP address and it worked.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"p\",null,{\"className\":\"flex justify-center\",\"children\":[\"$\",\"img\",null,{\"src\":\"/images/blog/240902-1/wireguard_8070_8878.png\",\"alt\":\"\"}]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"References:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.jeffgeerling.com/blog/2023/build-your-own-private-wireguard-vpn-pivpn\",\"children\":\"Jeef Geerling - Build your own private WireGuard VPN with\\nPiVPN\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://blog.apnic.net/2021/06/17/how-a-small-free-ip-tool-survived/\",\"children\":\"Information about icanhazip.com, you can use ident.me\\ninstead\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.reddit.com/r/explainlikeimfive/comments/1wqc30/eli5_how_does_nat_network_address_translation_work/\",\"children\":\"ELI5: How does NAT (Network Address Translation)\\nwork\"}]]}]]\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Remote Server behind CGNAT using Wireguard | Brian Phan\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"This is my portfolio.\"}],[\"$\",\"meta\",\"4\",{\"name\":\"robots\",\"content\":\"index, follow\"}],[\"$\",\"meta\",\"5\",{\"name\":\"googlebot\",\"content\":\"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:title\",\"content\":\"My Portfolio\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:description\",\"content\":\"This is my portfolio.\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:url\",\"content\":\"https://bachsofttrick.github.io\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:site_name\",\"content\":\"My Portfolio\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:locale\",\"content\":\"en_US\"}],[\"$\",\"meta\",\"11\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"12\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:title\",\"content\":\"My Portfolio\"}],[\"$\",\"meta\",\"14\",{\"name\":\"twitter:description\",\"content\":\"This is my portfolio.\"}],[\"$\",\"meta\",\"15\",{\"name\":\"next-size-adjust\"}]]\n5:null\n"])</script></body></html>