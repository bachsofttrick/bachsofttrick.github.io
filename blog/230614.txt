3:I[5505,[],""]
5:I[8694,[],""]
6:I[7951,["951","static/chunks/951-68001eacaacb5ddd.js","308","static/chunks/app/blog/%5Bslug%5D/page-68a8741e3efe855c.js"],""]
4:["slug","230614","d"]
0:["8p786RC143LgginfJufWE",[[["",{"children":["blog",{"children":[["slug","230614","d"],{"children":["__PAGE__?{\"slug\":\"230614\"}",{}]}]}]},"$undefined","$undefined",true],["",{"children":["blog",{"children":[["slug","230614","d"],{"children":["__PAGE__",{},[["$L1",["$","section",null,{"children":[["$","h1",null,{"className":"title font-semibold text-2xl tracking-tighter","children":"Trying a new kernel and compiling network driver from it"}],["$","div",null,{"className":"flex justify-between items-center mt-2 mb-8 text-sm","children":["$","p",null,{"className":"text-sm text-neutral-600 dark:text-neutral-400","children":"Jun 14, 2023"}]}],["$","article",null,{"className":"prose","children":"$L2"}]]}],null],null],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/5c2e7a9dbf5cdffa.css","precedence":"next","crossOrigin":"$undefined"}]],["$","html",null,{"lang":"en","className":"text-black bg-white dark:text-white dark:bg-black __variable_ac79ff __variable_8a4d12","children":["$","body",null,{"className":"antialiased max-w-4xl mx-4 mt-8 lg:mx-auto","children":["$","main",null,{"className":"flex-auto min-w-0 mt-6 flex flex-col px-2 md:px-0","children":[["$","aside",null,{"className":"-ml-[8px] mb-16 tracking-tight","children":["$","div",null,{"className":"lg:sticky lg:top-20","children":["$","nav",null,{"className":"flex flex-row items-start relative px-0 pb-0 fade md:overflow-auto scroll-pr-6 md:relative","id":"nav","children":["$","div",null,{"className":"flex flex-row space-x-0 pr-10","children":[["$","$L6","/",{"href":"/","className":"transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1","children":"home"}],["$","$L6","/about",{"href":"/about","className":"transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1","children":"about"}],["$","$L6","/blog",{"href":"/blog","className":"transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1","children":"blog"}]]}]}]}]}],["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","section",null,{"children":[["$","h1",null,{"className":"mb-8 text-2xl font-semibold tracking-tighter","children":"404 - Page Not Found"}],["$","p",null,{"className":"mb-4","children":"The page you are looking for does not exist."}]]}],"notFoundStyles":[]}],["$","footer",null,{"className":"mb-16","children":[["$","ul",null,{"className":"font-sm mt-8 flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300","children":[["$","li",null,{"children":["$undefined",["$","p",null,{"className":" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100","children":"Corvallis, Oregon, USA"}]]}],["$","li",null,{"children":["$undefined",["$","p",null,{"className":" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100","children":"Phone: 541-360-9231"}]]}]]}],["$","ul",null,{"className":"font-sm flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300","children":[["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100","rel":"noopener noreferrer","target":"_blank","href":"https://github.com/bachsofttrick","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"github"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100","rel":"noopener noreferrer","target":"_blank","href":"https://github.com/bachsofttrick/bachsofttrick.github.io","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"view source"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100","rel":"noopener noreferrer","target":"_blank","href":"https://linkedin.com/in/bach-phan-58530b1b0","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"linkedin"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100","rel":"noopener noreferrer","target":"_blank","href":"mailto:xuanbach1307@gmail.com","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"email"}]]}]}]]}],["$","p",null,{"className":"mt-8 text-neutral-600 dark:text-neutral-300","children":2024}]]}]]}]}]}]],null],null],[null,"$L7"]]]]
2:[["$","p",null,{"children":["In celebration of the release of ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.debian.org/News/2023/20230610","children":"Debian\n12"}],", I downloaded and tried\nit out on a VM (virtual machine). Unfortunately, my ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.realtek.com/en/component/zoo/category/network-interface-controllers-10-100-1000m-gigabit-ethernet-usb-3-0-software","children":"network\ndriver"}],"\nwon't compile under Linux kernel version 6.1. I thought they were just\nkidding when they said kernel version <= 5.17. So I held off upgrading\nmy server to Debian 12. A short while back, I read this\n",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://jamesachambers.com/orange-pi-i96-getting-started-guide/","children":"post"}],"\nabout getting i96 board from Orange Pi to work. That got me thinking.\n",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://askubuntu.com/questions/913351/why-are-the-operating-system-and-kernel-treated-separately-in-linux","children":"Are kernel and OS\nseparated?"}],"\nThe board in question could run Debian 11 Bullseye on kernel 3.10, which\nwas very old."]}],"\n",["$","h4",null,{"id":"debian-10","className":"$undefined","children":[[["$","a","link-debian-10",{"href":"#debian-10","className":"anchor"}]],"Debian 10"]}],"\n",["$","p",null,{"children":"Because I couldn't find the ISO for Debian 11 that is currently on my\nserver to replicate the server environment on a VM, I used Debian 10\nISO. Lucky enough! It came with kernel 4.19. While installing, I tried\nusing a mirror server from Vietnam to speed up downloading packages. It\nworked! So good that I changed mirrors on my server, my laptop OS to\nVietnam to. As previously, I downloaded packages from the sources, which\nare from the US so they were slow."}],"\n",["$","p",null,{"children":["I upgraded ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.cyberciti.biz/faq/update-upgrade-debian-10-to-debian-11-bullseye/","children":"Debian 10 to\n11"}],"\nby changing all instances of ",["$","em",null,{"children":"buster"}]," in ",["$","em",null,{"children":"/etc/apt/source.list"}]," to\n",["$","em",null,{"children":"bullseye"}]," and use ",["$","em",null,{"children":"apt full-upgrade"}],". Debian 11 gave me kernel 5.10,\nsame as my server. I added the\n",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://wiki.debian.org/Backports","children":["$","em",null,{"children":"backport"}]}]," repository to the apt\nsource list, because they have new softwares and kernels there:"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"deb http://debian.xtdv.net/debian/ bullseye-backports main"}]}],"\n",["$","p",null,{"children":"Next, I searched for a new kernel by filtering apt list:"}],"\n",["$","p",null,{"children":["$","em",null,{"children":"apt list linux-image* | less"}]}],"\n",["$","p",null,{"children":["It came up with tons of results so it could get confusing. Fortunately,\nthe kernel the OS used probably looks like ",["$","em",null,{"children":"linux-image-5.10.0-23-amd64"}],"\nso using this, I could track down the kernel I need, like\n",["$","em",null,{"children":"linux-image-6.1.0-0.deb11.7-amd64"}],". I did try one with ",["$","em",null,{"children":"cloud"}]," in it,\nand it shrunk the font on screen. After installing, it would generate a\nnew config file for the boot loader, GRUB. The next restart, it will\n",["$","em",null,{"children":"reboot to the new kernel"}],". And it did. Here was the result\nof ",["$","em",null,{"children":"uname -a"}],":"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"Linux debian 6.1.0-0.deb11.7-amd64 #1 SMP PREEMPT_DYNAMIC Debian\n6.1.20-2~bpo11+1 (2023-04-23) x86_64 GNU/Linux"}]}],"\n",["$","p",null,{"children":"* *"}],"\n",["$","p",null,{"children":["I also tried upgrading to Debian 12 while ",["$","em",null,{"children":"holding"}]," the\n",["$","em",null,{"children":"linux-image-amd64"}]," from upgrading, to see if it was possible to get to\nDebian 12 without using kernel 6.1. It also worked."]}],"\n",["$","h4",null,{"id":"lubuntu-2204","className":"$undefined","children":[[["$","a","link-lubuntu-2204",{"href":"#lubuntu-2204","className":"anchor"}]],"Lubuntu 22.04"]}],"\n",["$","p",null,{"children":["I replicated the experiment on a fresh Lubuntu 22.04.2 VM. It was a bit\ndifferent. The package I was looking for was\n",["$","em",null,{"children":"linux-image-5.15.0-73-generic"}],". The newest kernel they got was\n",["$","em",null,{"children":"linux-image-5.19.0-43-generic"}]," so I tried ",["$","em",null,{"children":"linux-image-6.1.0-1013-oem"}],".\nIt booted back in after installing and restarting the VM."]}],"\n",["$","h4",null,{"id":"compiling-driver","className":"$undefined","children":[[["$","a","link-compiling-driver",{"href":"#compiling-driver","className":"anchor"}]],"Compiling driver"]}],"\n",["$","p",null,{"children":["Back to Debian 11 with kernel 6.1, I tried compiling driver again after\ninstalling ",["$","em",null,{"children":"linux-headers-6.1.0-0.deb11.7-amd64"}],". It didn't work and it\ngave errors:"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"/home/bach/r8152-2.16.3/r8152.c: In function 'sg_en_store':"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"/home/bach/r8152-2.16.3/r8152.c:20462:2: error: implicit declaration of\nfunction 'netif_set_gso_max_size'; did you mean\n'netif_set_tso_max_size'? [-Werror=implicit-function-declaration]"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"20462 | netif_set_gso_max_size(netdev, tso_size);"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"| ^~~~~~~~~~~~~~~~~~~~~~"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"| netif_set_tso_max_size"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"/home/bach/r8152-2.16.3/r8152.c: In function 'rtl8152_probe':"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"/home/bach/r8152-2.16.3/r8152.c:20704:3: error: too many arguments to\nfunction 'netif_napi_add'"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"20704 | netif_napi_add(netdev, &tp->napi, r8152_poll, 256);"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"| ^~~~~~~~~~~~~~"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"In file included from /home/bach/r8152-2.16.3/r8152.c:16:"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"/usr/src/linux-headers-6.1.0-0.deb11.7-common/include/linux/netdevice.h:2569:1:\nnote: declared here"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"2569 | netif_napi_add(struct net_device *dev, struct napi_struct\n*napi,"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"| ^~~~~~~~~~~~~~"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"/home/bach/r8152-2.16.3/r8152.c:20706:3: error: too many arguments to\nfunction 'netif_napi_add'"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"20706 | netif_napi_add(netdev, &tp->napi, r8152_poll, 64);"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"| ^~~~~~~~~~~~~~"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"In file included from /home/bach/r8152-2.16.3/r8152.c:16:"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"/usr/src/linux-headers-6.1.0-0.deb11.7-common/include/linux/netdevice.h:2569:1:\nnote: declared here"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"2569 | netif_napi_add(struct net_device *dev, struct napi_struct\n*napi,"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"| ^~~~~~~~~~~~~~"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"cc1: some warnings being treated as errors"}]}],"\n",["$","p",null,{"children":["For the first error, I changed the function according to the tip. For\nthe following errors, I consulted the wisdom of the Internet and found\nthis\n",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://lore.kernel.org/netdev/20221002175650.1491124-1-kuba@kernel.org/t/","children":"patch"}],",\nso I changed the function again. I recompiled again and it got through.\nUsing ",["$","em",null,{"children":"modinfo r8152.ko"}]," yielded result that it was compiled using\nkernel 6.1:"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"vermagic: 6.1.0-0.deb11.7-amd64 SMP preempt mod_unload modversions"}]}],"\n",["$","h4",null,{"id":"compiling-driver-new-version-2171","className":"$undefined","children":[[["$","a","link-compiling-driver-new-version-2171",{"href":"#compiling-driver-new-version-2171","className":"anchor"}]],"Compiling driver (new version 2.17.1)"]}],"\n",["$","p",null,{"children":["After the release of Debian 12, Realtek issued an update on their\nRTL8156 source driver. I downloaded it and compiled against kernel\nversion 6.1 and installed it. It worked, without any errors from the old\nversion. There was also a driver already in the kernel so I tested both\ndrivers. The in-tree kernel module required firmwares to be installed,\nyou can find it in ",["$","em",null,{"children":"firmware-realtek"}]," package in ",["$","em",null,{"children":"bullseye-backports"}],"\nrepository. However, Debian didn't recognize the network USB, so I have\nto force driver by hand using this command as root (not sudo, it didn't\nwork):"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"echo 0bda 8156 > /sys/bus/usb/drivers/r8152/new_id"}]}],"\n",["$","p",null,{"children":["Then it recognized the USB. By using ",["$","strong",null,{"children":"iperf3"}],", I measured performance\nbetween 2 drivers. While they were able to saturate the 1Gbps bandwidth,\nthe in-tree module took 10% more CPU usage compared to the Realtek\ndriver. The in-tree module also required a hacky workaround for the\nserver to recognize, so I opted for the Realtek one."]}]]
7:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Trying a new kernel and compiling network driver from it | Brian Phan"}],["$","meta","3",{"name":"description","content":"This is my portfolio."}],["$","meta","4",{"name":"robots","content":"index, follow"}],["$","meta","5",{"name":"googlebot","content":"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"}],["$","meta","6",{"property":"og:title","content":"My Portfolio"}],["$","meta","7",{"property":"og:description","content":"This is my portfolio."}],["$","meta","8",{"property":"og:url","content":"https://bachsofttrick.github.io"}],["$","meta","9",{"property":"og:site_name","content":"My Portfolio"}],["$","meta","10",{"property":"og:locale","content":"en_US"}],["$","meta","11",{"property":"og:type","content":"website"}],["$","meta","12",{"name":"twitter:card","content":"summary"}],["$","meta","13",{"name":"twitter:title","content":"My Portfolio"}],["$","meta","14",{"name":"twitter:description","content":"This is my portfolio."}],["$","meta","15",{"name":"next-size-adjust"}]]
1:null
