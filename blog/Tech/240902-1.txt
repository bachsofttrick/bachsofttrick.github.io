3:I[4707,[],""]
6:I[6423,[],""]
7:I[4888,["972","static/chunks/972-d5884f09dde0387b.js","185","static/chunks/app/layout-9c3ad277717235be.js"],"GoogleAnalytics"]
8:I[2645,["972","static/chunks/972-d5884f09dde0387b.js","185","static/chunks/app/layout-9c3ad277717235be.js"],"Navbar"]
4:["category","Tech","d"]
5:["slug","240902-1","d"]
0:["bB_dy8pqBnRs1hZv6AeEb",[[["",{"children":["blog",{"children":[["category","Tech","d"],{"children":[["slug","240902-1","d"],{"children":["__PAGE__?{\"category\":\"Tech\",\"slug\":\"240902-1\"}",{}]}]}]}]},"$undefined","$undefined",true],["",{"children":["blog",{"children":[["category","Tech","d"],{"children":[["slug","240902-1","d"],{"children":["__PAGE__",{},[["$L1",["$","section",null,{"children":[["$","h1",null,{"className":"title font-semibold text-2xl tracking-tighter","children":"Remote Server behind CGNAT using Wireguard"}],["$","div",null,{"className":"flex justify-between items-center mt-2 mb-8 text-sm","children":["$","p",null,{"className":"text-sm text-neutral-600","children":"Sep 2, 2024"}]}],["$","article",null,{"className":"prose","children":"$L2"}]]}],[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/587fc2319eebab18.css","precedence":"next","crossOrigin":"$undefined"}]]],null],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children","$5","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/4d66c1a699081f75.css","precedence":"next","crossOrigin":"$undefined"}]],["$","html",null,{"lang":"en","className":"text-black bg-white __variable_ac79ff __variable_8a4d12","children":[["$","meta",null,{"name":"msvalidate.01","content":"D1474E050BE527719E98F0704865EEAE"}],["$","$L7",null,{"gaId":"G-N3J3E2ME0X"}],["$","body",null,{"className":"antialiased max-w-4xl mx-4 mt-8 lg:mx-auto","children":["$","main",null,{"className":"flex-auto min-w-0 mt-6 flex flex-col px-2 md:px-0","children":[["$","$L8",null,{}],["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","section",null,{"children":[["$","h1",null,{"className":"mb-8 text-2xl font-semibold tracking-tighter","children":"404 - Page Not Found"}],["$","p",null,{"className":"mb-4","children":"The page you are looking for does not exist."}]]}],"notFoundStyles":[]}],["$","footer",null,{"className":"mb-16","children":[["$","ul",null,{"className":"font-sm mt-8 flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0","children":[["$","li",null,{"children":["$undefined",["$","p",null,{"className":" h-7 flex items-center transition-all hover:text-neutral-800","children":"United States"}]]}],["$","li",null,{"children":["$undefined",["$","p",null,{"className":" h-7 flex items-center transition-all hover:text-neutral-800","children":"Phone: 541-360-9231"}]]}]]}],["$","ul",null,{"className":"font-sm flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0","children":[["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"https://github.com/bachsofttrick/","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"github"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"https://linkedin.com/in/brphan/","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"linkedin"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"mailto:xuanbach1307@gmail.com","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"email"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"https://github.com/bachsofttrick/bachsofttrick.github.io/raw/refs/heads/main/resume.docx","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"get resume"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"/rss.xml","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"rss"}]]}]}]]}],["$","p",null,{"className":"mt-8 text-neutral-600","children":2026}]]}]]}]}]]}]],null],null],["$L9",null]]]]
a:T46e,According to Mr. Geerling, he had a public IP (though not static) and
pointed his domain to this IP to connect to his network using Wireguard
installed by PiVPN. I do not have such luxury, as my public IP is
10.x.x.x through PPPoE to my ISP, Viettel, so using his way was out of
the question. I am stuck in a situation known as CGNAT. What's more, he
exposed ALL his network out, which, to each of their own, is quite
dangerous as the VPN can be used as an attack vector to your own
network. I did a similar thing while creating my own VOIP service using
Asterisk, but it only lasted a day, and I quickly closed it due to the
danger behind it. PiVPN, the tool he used, is quite fascinating and I
will look into it in the future. But back when I built my VPN, it was on
a virtual server, and I built it manually. I didn't know any automated
tool like his, I just followed some guides from DigitalOcean to set up
Wireguard, along with fail2ban, ssh. In fact, the reason I chose
Wireguard was that it was easier to set up. OpenVPN has a lot of moving
parts needed to run, while Wireguard only requires a pair of keys.
Granted, there are
2:[["$","p",null,{"children":["I keep delaying this post because it's something that has already been\ndone, and I don't want to repeat myself. But Jeff Geerling, a Youtuber I\nfollow, posted a ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.youtube.com/watch?v=5NJ6V8i1Xd8","children":"video"}],"\nabout deploying your own VPN to access your server from a remote\nlocation, and I feel like I must write my own experience on the matter."]}],"\n",["$","h4",null,{"id":"the-differences-in-my-approach","className":"flex justify-center","children":[[["$","a","link-the-differences-in-my-approach",{"href":"#the-differences-in-my-approach","className":"anchor"}]],"The differences in my approach"]}],"\n",["$","p",null,{"children":["$a",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://github.com/angristan/openvpn-install","children":"scripts"}]," that help\ninstall OpenVPN, but the performance is OpenVPN's Achilles's heel. I\nonly have 1 vCPU, so performance is kind of a big deal. Lastly, his\nvideo mentioned \"a little extra security on public Wifi\" and \"bypass\ncontent restriction\". While my VPN can't bypass any content restriction,\nit can provide encryption for my traffic on public Wifi, in addition to\nproviding its own DNS server to speed up DNS query."]}],"\n",["$","h4",null,{"id":"cgnat-carrier-grade-network-address-translation","className":"flex justify-center","children":[[["$","a","link-cgnat-carrier-grade-network-address-translation",{"href":"#cgnat-carrier-grade-network-address-translation","className":"anchor"}]],"CGNAT (carrier-grade network address translation)"]}],"\n",["$","p",null,{"children":["A blog ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.draytek.co.uk/information/blog/what-is-cgnat","children":"post"}],"\non Draytek explains this well, but to quote from a\n",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.reddit.com/r/HomeNetworking/comments/hi2sde/i_just_learned_my_internet_connection_is_cgnat_is/","children":"reddit"}],"\ncomment as a short version: \"CGNAT means your ISP doesn't have enough\npublic IPv4 addresses to assign one to each user. So they are\nessentially doing to you what your home router does to the Internet by\ngiving you a NAT'ed IP address. Yes, that means you can't run your own\nservers or forward traffic at home\". My situation may not technically be\nCGNAT, could be simply double NAT from my end and my ISP's, because my\n\"public\" IP is not in the CGNAT address block, which is usually from\n100.64.0.0 to 100.127.255.255, is 10.x.x.x. I first noticed this\nphenomenon in 2014, when I installed fiber. Though back then I didn't\nknow how to bridge the ISP router to my TP-Link router, I knew of double\nNAT and opened similar port on both routers to torrent. However, I\nchecked on ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://canyouseeme.org/","children":"https://canyouseeme.org/"}]," and they couldn't see the open\nport. The torrent could still download, but it couldn't upload. It was\nstrange, because before that, I could see the open port when I was still\non ADSL (also double NAT). It was my biggest achievement back in 8^th^\ngrade, to open port and torrent, or host my own radio using Windows\nMedia Encoder. The second biggest was getting 3D games to run on my\nPentium 4 computer."]}],"\n",["$","h4",null,{"id":"setting-up-virtual-server","className":"flex justify-center","children":[[["$","a","link-setting-up-virtual-server",{"href":"#setting-up-virtual-server","className":"anchor"}]],"Setting up virtual server"]}],"\n",["$","p",null,{"children":"There are a lot of options when choosing a virtual server provider. I\nchose Viettel IDC because it was the closest to home, and I also use\ntheir fiber service. I bought 1 vCore with 1GB RAM, 20GB SSD, 300 Mbps\nunlimited bandwidth. I chose Ubuntu Server as the base OS, because I'm\nused to Debian-based OS. I guess the way to choose your preferences\nworks the same in other providers, whether AWS, GCP, Linode..."}],"\n",["$","p",null,{"children":"Some steps I performed before setting up WIreguard:"}],"\n",["$","p",null,{"children":"- Install ssh to have remote access, instead of using console from\nbrowser. Change ssh port, only allow access with key"}],"\n",["$","p",null,{"children":["- Configure firewall using\n",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-20-04","children":"ufw"}],":\nDeny all incoming, allow ssh port, Wireguard port"]}],"\n",["$","p",null,{"children":["- Install\n",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.digitalocean.com/community/tutorials/how-fail2ban-works-to-protect-services-on-a-linux-server","children":"fail2ban"}],"\nto limit amount of login attempts"]}],"\n",["$","h4",null,{"id":"setting-up-wireguard","className":"flex justify-center","children":[[["$","a","link-setting-up-wireguard",{"href":"#setting-up-wireguard","className":"anchor"}]],"Setting up Wireguard"]}],"\n",["$","p",null,{"children":["I followed this\n",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04","children":"guide"}],"\non how to set up Wireguard Server. First, I generated 2 pairs of keys,\none for the server, one for the client using the commands:"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"wg genkey | sudo tee /etc/wireguard/private.key"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"sudo cat /etc/wireguard/private.key | wg pubkey | sudo tee\n/etc/wireguard/public.key"}]}],"\n",["$","p",null,{"children":["Following that, I had to choose a subnet. Since 192.168.0.x, 1.x are all\ntoo common, I chose anything from 2.x and up. After that, I went to\n",["$","em",null,{"children":"/etc/wireguard/"}],". I created a config file for my VPN, ",["$","em",null,{"children":"wg0.conf"}]]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"[Interface]"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"Address = 192.168.13.1/24"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PostUp = ufw allow 51820/udp"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PostUp = ufw route allow in on wg0"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PreDown = ufw delete allow 51820/udp"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PreDown = ufw route delete allow in on wg0"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"ListenPort = 51820"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PrivateKey = <server private key here>"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"[Peer]"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PublicKey = <client public key here>"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"AllowedIPs = 192.168.13.2/32"}]}],"\n",["$","p",null,{"children":[["$","em",null,{"children":"[Interface]"}]," is configurations for your own VPN interface, whether\nit's a server or a client. ",["$","em",null,{"children":"PostUp"}]," and ",["$","em",null,{"children":"PreDown"}]," are commands to run\n",["$","em",null,{"children":"after"}]," turning on the VPN server and ",["$","em",null,{"children":"before"}],"\nshutting down server, respectively. I set up a bunch of commands that\nopen port, allow traffic running inside VPN and vice versa when turning\noff server. ",["$","em",null,{"children":"[Peer]"}]," are configurations for clients that will connect\nto the server. Each ",["$","em",null,{"children":"[Peer]"}]," adds another client to the server.\n",["$","em",null,{"children":"AllowedIPs"}]," is where you type in the client's VPN IP address. If the\nclient also acts as a router to another subnet, for instance,\n192.168.0.x, you can add ",["$","em",null,{"children":"192.168.0.0/24"}]," and you can access that subnet\nfrom the VPN."]}],"\n",["$","p",null,{"children":["On my home server, not the virtual one. I also created a config file in\n",["$","em",null,{"children":"/etc/wireguard/wg0.conf"}],":"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"[Interface]"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PrivateKey = <client private key here>"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"Address = 192.168.13.2/24"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"DNS = 8.8.8.8"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"[Peer]"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PublicKey = <server public key here>"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"AllowedIPs = 192.168.13.0/24"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"Endpoint = <server real IP>:51820"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PersistentKeepalive = 25"}]}],"\n",["$","p",null,{"children":[["$","em",null,{"children":"[Peer]"}]," here means something different. For a client to connect to a\nserver, it only needs 1 peer. For ",["$","em",null,{"children":"Endpoint"}],", you need to pinpoint the\nvirtual server's IP address. ",["$","em",null,{"children":"PersistentKeepalive"}]," is necessary to keep\nthe connection up, as we are running essentially a tunnel from the\nvirtual server to the real one. If the client isn't a server, that part\nwon't be needed."]}],"\n",["$","p",null,{"children":["On both servers, I typed in ",["$","em",null,{"children":"wg-quick up wg0"}],". I pinged from each side\nwith the other's IP address and it worked."]}],"\n",["$","p",null,{"children":["$","p",null,{"className":"flex justify-center","children":["$","img",null,{"src":"/images/blog/Tech/24/240902-1/wireguard_8070_8878.png","alt":""}]}]}],"\n",["$","p",null,{"children":"References:"}],"\n",["$","p",null,{"children":["- ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.jeffgeerling.com/blog/2023/build-your-own-private-wireguard-vpn-pivpn","children":"Jeef Geerling - Build your own private WireGuard VPN with\nPiVPN"}]]}],"\n",["$","p",null,{"children":["- ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://blog.apnic.net/2021/06/17/how-a-small-free-ip-tool-survived/","children":"Information about icanhazip.com, you can use ident.me\ninstead"}]]}],"\n",["$","p",null,{"children":["- ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.reddit.com/r/explainlikeimfive/comments/1wqc30/eli5_how_does_nat_network_address_translation_work/","children":"ELI5: How does NAT (Network Address Translation)\nwork"}]]}]]
9:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Remote Server behind CGNAT using Wireguard | Brian Phan"}],["$","meta","3",{"name":"description","content":"I keep delaying this post because it's something that has already been\ndone, and I don't want to repeat myself. But Jeff Geerling, a Youtuber I\nfollow, posted a [video](https://www.youtube.com/watch?v..."}],["$","meta","4",{"name":"robots","content":"index, follow"}],["$","meta","5",{"name":"googlebot","content":"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"}],["$","meta","6",{"property":"og:title","content":"Remote Server behind CGNAT using Wireguard"}],["$","meta","7",{"property":"og:description","content":"I keep delaying this post because it's something that has already been\ndone, and I don't want to repeat myself. But Jeff Geerling, a Youtuber I\nfollow, posted a [video](https://www.youtube.com/watch?v..."}],["$","meta","8",{"property":"og:url","content":"https://bachsofttrick.github.io/blog/Tech/240902-1"}],["$","meta","9",{"property":"og:type","content":"article"}],["$","meta","10",{"property":"article:published_time","content":"2024-09-02"}],["$","meta","11",{"property":"article:section","content":"Tech"}],["$","meta","12",{"name":"twitter:card","content":"summary"}],["$","meta","13",{"name":"twitter:title","content":"Remote Server behind CGNAT using Wireguard"}],["$","meta","14",{"name":"twitter:description","content":"I keep delaying this post because it's something that has already been\ndone, and I don't want to repeat myself. But Jeff Geerling, a Youtuber I\nfollow, posted a [video](https://www.youtube.com/watch?v..."}],["$","meta","15",{"name":"next-size-adjust"}]]
1:null
