3:I[4707,[],""]
6:I[6423,[],""]
7:I[4888,["972","static/chunks/972-d5884f09dde0387b.js","185","static/chunks/app/layout-9c3ad277717235be.js"],"GoogleAnalytics"]
8:I[2645,["972","static/chunks/972-d5884f09dde0387b.js","185","static/chunks/app/layout-9c3ad277717235be.js"],"Navbar"]
4:["category","Tech","d"]
5:["slug","230504","d"]
0:["bB_dy8pqBnRs1hZv6AeEb",[[["",{"children":["blog",{"children":[["category","Tech","d"],{"children":[["slug","230504","d"],{"children":["__PAGE__?{\"category\":\"Tech\",\"slug\":\"230504\"}",{}]}]}]}]},"$undefined","$undefined",true],["",{"children":["blog",{"children":[["category","Tech","d"],{"children":[["slug","230504","d"],{"children":["__PAGE__",{},[["$L1",["$","section",null,{"children":[["$","h1",null,{"className":"title font-semibold text-2xl tracking-tighter","children":"Auto build driver when updating Linux kernel with dkms"}],["$","div",null,{"className":"flex justify-between items-center mt-2 mb-8 text-sm","children":["$","p",null,{"className":"text-sm text-neutral-600","children":"May 4, 2023"}]}],["$","article",null,{"className":"prose","children":"$L2"}]]}],[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/587fc2319eebab18.css","precedence":"next","crossOrigin":"$undefined"}]]],null],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children","$5","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/4d66c1a699081f75.css","precedence":"next","crossOrigin":"$undefined"}]],["$","html",null,{"lang":"en","className":"text-black bg-white __variable_ac79ff __variable_8a4d12","children":[["$","meta",null,{"name":"msvalidate.01","content":"D1474E050BE527719E98F0704865EEAE"}],["$","$L7",null,{"gaId":"G-N3J3E2ME0X"}],["$","body",null,{"className":"antialiased max-w-4xl mx-4 mt-8 lg:mx-auto","children":["$","main",null,{"className":"flex-auto min-w-0 mt-6 flex flex-col px-2 md:px-0","children":[["$","$L8",null,{}],["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","section",null,{"children":[["$","h1",null,{"className":"mb-8 text-2xl font-semibold tracking-tighter","children":"404 - Page Not Found"}],["$","p",null,{"className":"mb-4","children":"The page you are looking for does not exist."}]]}],"notFoundStyles":[]}],["$","footer",null,{"className":"mb-16","children":[["$","ul",null,{"className":"font-sm mt-8 flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0","children":[["$","li",null,{"children":["$undefined",["$","p",null,{"className":" h-7 flex items-center transition-all hover:text-neutral-800","children":"United States"}]]}],["$","li",null,{"children":["$undefined",["$","p",null,{"className":" h-7 flex items-center transition-all hover:text-neutral-800","children":"Phone: 541-360-9231"}]]}]]}],["$","ul",null,{"className":"font-sm flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0","children":[["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"https://github.com/bachsofttrick/","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"github"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"https://linkedin.com/in/brphan/","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"linkedin"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"mailto:xuanbach1307@gmail.com","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"email"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"https://github.com/bachsofttrick/bachsofttrick.github.io/raw/refs/heads/main/resume.docx","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"get resume"}]]}]}],["$","li",null,{"children":["$","a",null,{"className":"flex items-center transition-all hover:text-neutral-800","rel":"noopener noreferrer","target":"_blank","href":"/rss.xml","children":[["$","svg",null,{"width":"12","height":"12","viewBox":"0 0 12 12","fill":"none","xmlns":"http://www.w3.org/2000/svg","children":["$","path",null,{"d":"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z","fill":"currentColor"}]}],["$","p",null,{"className":"ml-2 h-7","children":"rss"}]]}]}]]}],["$","p",null,{"className":"mt-8 text-neutral-600","children":2026}]]}]]}]}]]}]],null],null],["$L9",null]]]]
2:[["$","p",null,{"children":"I am a media consumption enthusiast. Let's just say I watch movies a\nlot. Usually, people like me will have a big home theater setup with a\nlarge TV, a large speaker set, a media player with huge HDD storage. But\nthat sounds like too much work, since you have to update the hard drive\nconstantly with new catalogues. So I built my server out of an old i3\nlaptop, a SSD, 2 HDD lying around with a dock and an Ethernet USB\ndongle. I chose 2.5 Gbps dongle version because I wanted to future-proof\nmy server. But that proved to be my undoing, because the OS I chose for\nmy server, Debian, had an older version of the driver that didn't\nsupport the RTL8156 chipset. It might support an older one, the RTL8153,\nwhich is the 1 Gbps variant. So I searched for its driver. It's quite a\nlittle adventure."}],"\n",["$","p",null,{"children":["$","p",null,{"className":"flex justify-center","children":["$","img",null,{"src":"/images/blog/Tech/23/230504/DKMS_flow.webp","alt":""}]}]}],"\n",["$","h4",null,{"id":"first-time-compiling-from-source","className":"flex justify-center","children":[[["$","a","link-first-time-compiling-from-source",{"href":"#first-time-compiling-from-source","className":"anchor"}]],"First time compiling from source"]}],"\n",["$","p",null,{"children":"A Google search for RTL8156 driver for linux led me to the\nmanufacturer's driver page to download the driver. However, the\ncompressed file I downloaded (in this instance .tar.bz2) didn't have any\n.deb file to install. Instead I was left with a bunch of .h, .c files\nwith a Makefile. I thought: \"Wait. This is a source code!\"."}],"\n",["$","p",null,{"children":"So far, I have mostly installed apps and drivers through apt so this was\na new territory. I did some researches and tried compiling the driver.\nIn the source code folder, I typed:"}],"\n",["$","p",null,{"children":["$","em",null,{"children":"make -j4"}]}],"\n",["$","p",null,{"children":["With -j4 being number of jobs to run simultaneously, 4 is the number of\nthreads of my CPU. After it finished, the result was r8152.ko file, a\nkernel module. I plugged in the Ethernet USB. It didn't work. Then I\ntried loading the module into the kernel like ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.tecmint.com/load-and-unload-kernel-modules-in-linux/","children":"this\narticle"}],"\nsuggested:"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"insmod r8152.ko"}]}],"\n",["$","p",null,{"children":"Then it worked. My server recognized it."}],"\n",["$","p",null,{"children":["$","em",null,{"children":"ip a"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"3: enx00e04e3b0ac0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc\npfifo_fast state UP mode DEFAULT group default qlen 1000"}]}],"\n",["$","p",null,{"children":["I edited the ",["$","em",null,{"children":"interface"}],"s file in ",["$","em",null,{"children":"/etc/network"}]," to assign it a static\naddress by adding:"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"allow-hotplug enx00e04e3b0ac0"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"iface enx00e04e3b0ac0 inet static"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"address 192.168.4.3/24"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"gateway 192.168.4.1"}]}],"\n",["$","p",null,{"children":["For then on, I could access my server in my house through that IP,\n",["$","em",null,{"children":"192.168.4.3."}]]}],"\n",["$","p",null,{"children":"But I discovered that:"}],"\n",["$","p",null,{"children":["- At start-up, I have to ",["$","em",null,{"children":"insmod"}]," like that to load the module. This\nwas solved by simply copying that module to /lib/modules/$(uname\n-r)/kernel/drivers/net/usb. Didn't have to ",["$","em",null,{"children":"insmod"}]," anymore. But that\nwasn't all."]}],"\n",["$","p",null,{"children":"- Every time I update the server with apt update, apt upgrade, and\nthere is a kernel update, I have to compile module from source, copy it\nover again or else I lose the driver. So I often delay updating my\nserver, which is bad because you want to keep your kernel up-to-date on\nbugfix, vulnerabilities."}],"\n",["$","p",null,{"children":"I needed a way to make it compile every time there is a kernel update.\nSo is there a way?"}],"\n",["$","h4",null,{"id":"dkms-dynamic-kernel-module-support","className":"flex justify-center","children":[[["$","a","link-dkms-dynamic-kernel-module-support",{"href":"#dkms-dynamic-kernel-module-support","className":"anchor"}]],"dkms - Dynamic Kernel Module Support"]}],"\n",["$","p",null,{"children":"Nowadays, I use an Ubuntu desktop as my main driver. I often see\nsomething along the line of dkms for my Nvidia card anytime there is a\nkernel update. After rebooting, the video card still works with the new\nkernel. Naturally, I started looking into this \"dkms\"."}],"\n",["$","p",null,{"children":["According to this ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://linuxhint.com/dkms-linux/","children":"article"}],", dkms\n",["$","em",null,{"children":"\"is a framework where device driver source can reside outside the\nkernel source tree so that it is very easy to rebuild modules as you\nupgrade kernels\""}],". So this is the stuff I was looking for. The author\nalso encountered dkms similarly to me, but by following guides to\ninstall his Wifi driver."]}],"\n",["$","p",null,{"children":["So with the source code of my Ethernet USB, I copied it to ",["$","em",null,{"children":"/usr/src"}],". I\nalso created a file inside the source code's folder, ",["$","em",null,{"children":"dkms.conf"}]," with\nthe following content:"]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PACKAGE_NAME=\"r8152\""}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"PACKAGE_VERSION=\"2.15.0\""}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"BUILT_MODULE_NAME[0]=\"r8152\""}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"MAKE=\"'make' -j$(nproc) KVER=${kernelver}\""}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"CLEAN=\"'make' clean\""}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"DEST_MODULE_LOCATION[0]=\"/kernel/drivers/net/usb/\""}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"AUTOINSTALL=\"YES\""}]}],"\n",["$","p",null,{"children":"PACKAGE_NAME gives the name to the entire package of modules."}],"\n",["$","p",null,{"children":"PACKAGE_VERSION give the version of the entire package of modules being\ninstalled with dkms. These two form the name of the folder that contains\nthe source code, *r8152-2.15.0."}],"\n",["$","p",null,{"children":"BUILT_MODULE_NAME gives the name of the module just after it is built."}],"\n",["$","p",null,{"children":["DEST_MODULE_LOCATION specifies the destination where a module should\nbe installed to, once compiled. From the example: /lib/modules/$(uname\n-r)",["$","em",null,{"children":"/kernel/drivers/net/usb"}],"."]}],"\n",["$","p",null,{"children":"Note that for each module within a dkms package, the numeric value of #\nmust be the same for each of BUILT_MODULE_NAME and\nDEST_MODULE_LOCATION and that the numbering should start at 0. So each\nmodule goes with its own destination"}],"\n",["$","p",null,{"children":"MAKE and CLEAN correspond to commands used to run when dkms builds\n(make) the module and cleans up after."}],"\n",["$","p",null,{"children":"AUTOINSTALL is set to yes so that the service\n/etc/rc.d/init.d/dkms_autoinstaller will automatically try to install\nthis module when upgrading kernel."}],"\n",["$","p",null,{"children":"After that, I ran three commands:"}],"\n",["$","p",null,{"children":["- ",["$","em",null,{"children":"sudo dkms add r8152/2.15.0"}]]}],"\n",["$","p",null,{"children":["- ",["$","em",null,{"children":"sudo dkms build r8152/2.15.0"}]]}],"\n",["$","p",null,{"children":["- ",["$","em",null,{"children":"sudo dkms install r8152/2.15.0"}]]}],"\n",["$","p",null,{"children":"And it installed the driver to the kernel. From then on, it will build\nand reinstall anytime I upgrade the kernel."}],"\n",["$","p",null,{"children":"Result:"}],"\n",["$","p",null,{"children":["$","em",null,{"children":"sudo dkms add r8152/2.15.0"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"Creating symlink /var/lib/dkms/r8152/2.15.0/source ->"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"/usr/src/r8152-2.15.0"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"DKMS: add completed."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"sudo dkms build r8152/2.15.0"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"Kernel preparation unnecessary for this kernel. Skipping..."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"Building module:"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"cleaning build area..."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"'make' -j4 KVER=5.10.0-22-amd64......"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"cleaning build area..."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"DKMS: build completed."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"sudo dkms install r8152/2.15.0"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"r8152.ko:"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"Running module version sanity check."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"Good news! Module version v2.15.0 for r8152.ko"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"exactly matches what is already found in kernel 5.10.0-22-amd64."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"DKMS will not replace this module."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"You may override by specifying --force."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"depmod...."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"DKMS: install completed."}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"dkms status"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"broadcom-sta, 6.30.223.271, 5.10.0-20-amd64, x86_64: installed"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"broadcom-sta, 6.30.223.271, 5.10.0-22-amd64, x86_64: installed"}]}],"\n",["$","p",null,{"children":["$","em",null,{"children":"[r8152, 2.15.0, 5.10.0-22-amd64, x86_64: installed]"}]}],"\n",["$","p",null,{"children":["If you wish to remove the driver, type in ",["$","em",null,{"children":"\"dkms remove r8152/2.15.0\n--all\""}],"."]}],"\n",["$","p",null,{"children":"References:"}],"\n",["$","p",null,{"children":["- ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://linux.die.net/man/8/dkms","children":"man dkms"}]]}],"\n",["$","p",null,{"children":["- ",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://www.realtek.com/en/component/zoo/category/network-interface-controllers-10-100-1000m-gigabit-ethernet-usb-3-0-software","children":"Realtek USB FE / GBE / 2.5G / Gaming Ethernet Family Controller\nSoftware"}]]}],"\n",["$","p",null,{"children":["-\n",["$","a",null,{"target":"_blank","rel":"noopener noreferrer","href":"https://github.com/brektrou/rtl8821CU/blob/master/dkms-install.sh","children":"rtl8821CU"}]]}]]
9:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Auto build driver when updating Linux kernel with dkms | Brian Phan"}],["$","meta","3",{"name":"description","content":"I am a media consumption enthusiast. Let's just say I watch movies a\nlot. Usually, people like me will have a big home theater setup with a\nlarge TV, a large speaker set, a media player with huge HDD ..."}],["$","meta","4",{"name":"robots","content":"index, follow"}],["$","meta","5",{"name":"googlebot","content":"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"}],["$","meta","6",{"property":"og:title","content":"Auto build driver when updating Linux kernel with dkms"}],["$","meta","7",{"property":"og:description","content":"I am a media consumption enthusiast. Let's just say I watch movies a\nlot. Usually, people like me will have a big home theater setup with a\nlarge TV, a large speaker set, a media player with huge HDD ..."}],["$","meta","8",{"property":"og:url","content":"https://bachsofttrick.github.io/blog/Tech/230504"}],["$","meta","9",{"property":"og:type","content":"article"}],["$","meta","10",{"property":"article:published_time","content":"2023-05-04"}],["$","meta","11",{"property":"article:section","content":"Tech"}],["$","meta","12",{"name":"twitter:card","content":"summary"}],["$","meta","13",{"name":"twitter:title","content":"Auto build driver when updating Linux kernel with dkms"}],["$","meta","14",{"name":"twitter:description","content":"I am a media consumption enthusiast. Let's just say I watch movies a\nlot. Usually, people like me will have a big home theater setup with a\nlarge TV, a large speaker set, a media player with huge HDD ..."}],["$","meta","15",{"name":"next-size-adjust"}]]
1:null
