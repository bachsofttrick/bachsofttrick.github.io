<!DOCTYPE html><html lang="en" class="text-black bg-white dark:text-white dark:bg-black __variable_ac79ff __variable_8a4d12"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/ec1a1eae803b668e-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/f980ec13b5b5e554.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="/images/blog/230504/DKMS_flow.webp"/><link rel="stylesheet" href="/_next/static/css/3f2ffb99d04a4301.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/f748654d5fd56294.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-0634df96d122c8a2.js"/><script src="/_next/static/chunks/3471c0f1-010786d28242dc9d.js" async=""></script><script src="/_next/static/chunks/6-82f781cfdf3075d7.js" async=""></script><script src="/_next/static/chunks/main-app-772f677cdc9845ce.js" async=""></script><script src="/_next/static/chunks/951-68001eacaacb5ddd.js" async=""></script><script src="/_next/static/chunks/app/blog/%5Bslug%5D/page-ed12fe06ba2a1fcb.js" async=""></script><title>Auto build driver when updating Linux kernel with dkms | Brian Phan</title><meta name="description" content="This is my portfolio."/><meta name="robots" content="index, follow"/><meta name="googlebot" content="index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"/><meta property="og:title" content="My Portfolio"/><meta property="og:description" content="This is my portfolio."/><meta property="og:url" content="https://bachsofttrick.github.io"/><meta property="og:site_name" content="My Portfolio"/><meta property="og:locale" content="en_US"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="My Portfolio"/><meta name="twitter:description" content="This is my portfolio."/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="antialiased max-w-4xl mx-4 mt-8 lg:mx-auto"><main class="flex-auto min-w-0 mt-6 flex flex-col px-2 md:px-0"><aside class="-ml-[8px] mb-16 tracking-tight"><div class="lg:sticky lg:top-20"><nav class="flex flex-row items-start relative px-0 pb-0 fade md:overflow-auto scroll-pr-6 md:relative" id="nav"><div class="flex flex-row space-x-0 pr-10"><a class="transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1" href="/">home</a><a class="transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1" href="/about">about</a><a class="transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1" href="/blog">blog</a></div></nav></div></aside><section><h1 class="title font-semibold text-2xl tracking-tighter">Auto build driver when updating Linux kernel with dkms</h1><div class="flex justify-between items-center mt-2 mb-8 text-sm"><p class="text-sm text-neutral-600 dark:text-neutral-400">May 4, 2023</p></div><article class="prose"><p>I am a media consumption enthusiast. Let&#x27;s just say I watch movies a
lot. Usually, people like me will have a big home theater setup with a
large TV, a large speaker set, a media player with huge HDD storage. But
that sounds like too much work, since you have to update the hard drive
constantly with new catalogues. So I built my server out of an old i3
laptop, a SSD, 2 HDD lying around with a dock and an Ethernet USB
dongle. I chose 2.5 Gbps dongle version because I wanted to future-proof
my server. But that proved to be my undoing, because the OS I chose for
my server, Debian, had an older version of the driver that didn&#x27;t
support the RTL8156 chipset. It might support an older one, the RTL8153,
which is the 1 Gbps variant. So I searched for its driver. It&#x27;s quite a
little adventure.</p>
<p><p class="flex justify-center"><img src="/images/blog/230504/DKMS_flow.webp" alt=""/></p></p>
<h4 id="first-time-compiling-from-source"><a href="#first-time-compiling-from-source" class="anchor"></a>First time compiling from source</h4>
<p>A Google search for RTL8156 driver for linux led me to the
manufacturer&#x27;s driver page to download the driver. However, the
compressed file I downloaded (in this instance .tar.bz2) didn&#x27;t have any
.deb file to install. Instead I was left with a bunch of .h, .c files
with a Makefile. I thought: &quot;Wait. This is a source code!&quot;.</p>
<p>So far, I have mostly installed apps and drivers through apt so this was
a new territory. I did some researches and tried compiling the driver.
In the source code folder, I typed:</p>
<p><em>make -j4</em></p>
<p>With -j4 being number of jobs to run simultaneously, 4 is the number of
threads of my CPU. After it finished, the result was r8152.ko file, a
kernel module. I plugged in the Ethernet USB. It didn&#x27;t work. Then I
tried loading the module into the kernel like <a target="_blank" rel="noopener noreferrer" href="https://www.tecmint.com/load-and-unload-kernel-modules-in-linux/">this
article</a>
suggested:</p>
<p><em>insmod r8152.ko</em></p>
<p>Then it worked. My server recognized it.</p>
<p><em>ip a</em></p>
<p><em>3: enx00e04e3b0ac0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc
pfifo_fast state UP mode DEFAULT group default qlen 1000</em></p>
<p>I edited the <em>interface</em>s file in <em>/etc/network</em> to assign it a static
address by adding:</p>
<p><em>allow-hotplug enx00e04e3b0ac0</em></p>
<p><em>iface enx00e04e3b0ac0 inet static</em></p>
<p><em>address 192.168.4.3/24</em></p>
<p><em>gateway 192.168.4.1</em></p>
<p>For then on, I could access my server in my house through that IP,
<em>192.168.4.3.</em></p>
<p>But I discovered that:</p>
<p>- At start-up, I have to <em>insmod</em> like that to load the module. This
was solved by simply copying that module to /lib/modules/$(uname
-r)/kernel/drivers/net/usb. Didn&#x27;t have to <em>insmod</em> anymore. But that
wasn&#x27;t all.</p>
<p>- Every time I update the server with apt update, apt upgrade, and
there is a kernel update, I have to compile module from source, copy it
over again or else I lose the driver. So I often delay updating my
server, which is bad because you want to keep your kernel up-to-date on
bugfix, vulnerabilities.</p>
<p>I needed a way to make it compile every time there is a kernel update.
So is there a way?</p>
<h4 id="dkms-dynamic-kernel-module-support"><a href="#dkms-dynamic-kernel-module-support" class="anchor"></a>dkms - Dynamic Kernel Module Support</h4>
<p>Nowadays, I use an Ubuntu desktop as my main driver. I often see
something along the line of dkms for my Nvidia card anytime there is a
kernel update. After rebooting, the video card still works with the new
kernel. Naturally, I started looking into this &quot;dkms&quot;.</p>
<p>According to this <a target="_blank" rel="noopener noreferrer" href="https://linuxhint.com/dkms-linux/">article</a>, dkms
<em>&quot;is a framework where device driver source can reside outside the
kernel source tree so that it is very easy to rebuild modules as you
upgrade kernels&quot;</em>. So this is the stuff I was looking for. The author
also encountered dkms similarly to me, but by following guides to
install his Wifi driver.</p>
<p>So with the source code of my Ethernet USB, I copied it to <em>/usr/src</em>. I
also created a file inside the source code&#x27;s folder, <em>dkms.conf</em> with
the following content:</p>
<p><em>PACKAGE_NAME=&quot;r8152&quot;</em></p>
<p><em>PACKAGE_VERSION=&quot;2.15.0&quot;</em></p>
<p><em>BUILT_MODULE_NAME[0]=&quot;r8152&quot;</em></p>
<p><em>MAKE=&quot;&#x27;make&#x27; -j$(nproc) KVER=${kernelver}&quot;</em></p>
<p><em>CLEAN=&quot;&#x27;make&#x27; clean&quot;</em></p>
<p><em>DEST_MODULE_LOCATION[0]=&quot;/kernel/drivers/net/usb/&quot;</em></p>
<p><em>AUTOINSTALL=&quot;YES&quot;</em></p>
<p>PACKAGE_NAME gives the name to the entire package of modules.</p>
<p>PACKAGE_VERSION give the version of the entire package of modules being
installed with dkms. These two form the name of the folder that contains
the source code, *r8152-2.15.0.</p>
<p>BUILT_MODULE_NAME gives the name of the module just after it is built.</p>
<p>DEST_MODULE_LOCATION specifies the destination where a module should
be installed to, once compiled. From the example: /lib/modules/$(uname
-r)<em>/kernel/drivers/net/usb</em>.</p>
<p>Note that for each module within a dkms package, the numeric value of #
must be the same for each of BUILT_MODULE_NAME and
DEST_MODULE_LOCATION and that the numbering should start at 0. So each
module goes with its own destination</p>
<p>MAKE and CLEAN correspond to commands used to run when dkms builds
(make) the module and cleans up after.</p>
<p>AUTOINSTALL is set to yes so that the service
/etc/rc.d/init.d/dkms_autoinstaller will automatically try to install
this module when upgrading kernel.</p>
<p>After that, I ran three commands:</p>
<p>- <em>sudo dkms add r8152/2.15.0</em></p>
<p>- <em>sudo dkms build r8152/2.15.0</em></p>
<p>- <em>sudo dkms install r8152/2.15.0</em></p>
<p>And it installed the driver to the kernel. From then on, it will build
and reinstall anytime I upgrade the kernel.</p>
<p>Result:</p>
<p><em>sudo dkms add r8152/2.15.0</em></p>
<p><em>Creating symlink /var/lib/dkms/r8152/2.15.0/source -&gt;</em></p>
<p><em>/usr/src/r8152-2.15.0</em></p>
<p><em>DKMS: add completed.</em></p>
<p><em>sudo dkms build r8152/2.15.0</em></p>
<p><em>Kernel preparation unnecessary for this kernel. Skipping...</em></p>
<p><em>Building module:</em></p>
<p><em>cleaning build area...</em></p>
<p><em>&#x27;make&#x27; -j4 KVER=5.10.0-22-amd64......</em></p>
<p><em>cleaning build area...</em></p>
<p><em>DKMS: build completed.</em></p>
<p><em>sudo dkms install r8152/2.15.0</em></p>
<p><em>r8152.ko:</em></p>
<p><em>Running module version sanity check.</em></p>
<p><em>Good news! Module version v2.15.0 for r8152.ko</em></p>
<p><em>exactly matches what is already found in kernel 5.10.0-22-amd64.</em></p>
<p><em>DKMS will not replace this module.</em></p>
<p><em>You may override by specifying --force.</em></p>
<p><em>depmod....</em></p>
<p><em>DKMS: install completed.</em></p>
<p><em>dkms status</em></p>
<p><em>broadcom-sta, 6.30.223.271, 5.10.0-20-amd64, x86_64: installed</em></p>
<p><em>broadcom-sta, 6.30.223.271, 5.10.0-22-amd64, x86_64: installed</em></p>
<p><em>[r8152, 2.15.0, 5.10.0-22-amd64, x86_64: installed]</em></p>
<p>If you wish to remove the driver, type in <em>&quot;dkms remove r8152/2.15.0
--all&quot;</em>.</p>
<p>References:</p>
<p>- <a target="_blank" rel="noopener noreferrer" href="https://linux.die.net/man/8/dkms">man dkms</a></p>
<p>- <a target="_blank" rel="noopener noreferrer" href="https://www.realtek.com/en/component/zoo/category/network-interface-controllers-10-100-1000m-gigabit-ethernet-usb-3-0-software">Realtek USB FE / GBE / 2.5G / Gaming Ethernet Family Controller
Software</a></p>
<p>-
<a target="_blank" rel="noopener noreferrer" href="https://github.com/brektrou/rtl8821CU/blob/master/dkms-install.sh">rtl8821CU</a></p></article></section><footer class="mb-16"><ul class="font-sm mt-8 flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300"><li><p class=" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100">Corvallis, Oregon, USA</p></li><li><p class=" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100">Phone: 541-360-9231</p></li></ul><ul class="font-sm flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300"><li><a class="flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100" rel="noopener noreferrer" target="_blank" href="https://github.com/bachsofttrick"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z" fill="currentColor"></path></svg><p class="ml-2 h-7">github</p></a></li><li><a class="flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100" rel="noopener noreferrer" target="_blank" href="https://github.com/bachsofttrick/bachsofttrick.github.io"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z" fill="currentColor"></path></svg><p class="ml-2 h-7">view source</p></a></li><li><a class="flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100" rel="noopener noreferrer" target="_blank" href="https://linkedin.com/in/brian-phan-58530b1b0/"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z" fill="currentColor"></path></svg><p class="ml-2 h-7">linkedin</p></a></li><li><a class="flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100" rel="noopener noreferrer" target="_blank" href="mailto:xuanbach1307@gmail.com"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z" fill="currentColor"></path></svg><p class="ml-2 h-7">email</p></a></li></ul><p class="mt-8 text-neutral-600 dark:text-neutral-300">2024</p></footer></main><script src="/_next/static/chunks/webpack-0634df96d122c8a2.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/ec1a1eae803b668e-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/f980ec13b5b5e554.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/css/3f2ffb99d04a4301.css\",\"style\"]\n4:HL[\"/_next/static/css/f748654d5fd56294.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"5:I[4163,[],\"\"]\n8:I[5505,[],\"\"]\na:I[8694,[],\"\"]\nb:I[7951,[\"951\",\"static/chunks/951-68001eacaacb5ddd.js\",\"308\",\"static/chunks/app/blog/%5Bslug%5D/page-ed12fe06ba2a1fcb.js\"],\"\"]\nd:I[8233,[],\"\"]\n9:[\"slug\",\"230504\",\"d\"]\ne:[]\n"])</script><script>self.__next_f.push([1,"0:[\"$\",\"$L5\",null,{\"buildId\":\"sVcR_x4xIpu14UJyjscez\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"blog\",\"230504\"],\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"230504\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"230504\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"230504\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L6\",[\"$\",\"section\",null,{\"children\":[[\"$\",\"h1\",null,{\"className\":\"title font-semibold text-2xl tracking-tighter\",\"children\":\"Auto build driver when updating Linux kernel with dkms\"}],[\"$\",\"div\",null,{\"className\":\"flex justify-between items-center mt-2 mb-8 text-sm\",\"children\":[\"$\",\"p\",null,{\"className\":\"text-sm text-neutral-600 dark:text-neutral-400\",\"children\":\"May 4, 2023\"}]}],[\"$\",\"article\",null,{\"className\":\"prose\",\"children\":\"$L7\"}]]}],[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/f748654d5fd56294.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]],null],null]},[null,[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$9\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/3f2ffb99d04a4301.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"text-black bg-white dark:text-white dark:bg-black __variable_ac79ff __variable_8a4d12\",\"children\":[\"$\",\"body\",null,{\"className\":\"antialiased max-w-4xl mx-4 mt-8 lg:mx-auto\",\"children\":[\"$\",\"main\",null,{\"className\":\"flex-auto min-w-0 mt-6 flex flex-col px-2 md:px-0\",\"children\":[[\"$\",\"aside\",null,{\"className\":\"-ml-[8px] mb-16 tracking-tight\",\"children\":[\"$\",\"div\",null,{\"className\":\"lg:sticky lg:top-20\",\"children\":[\"$\",\"nav\",null,{\"className\":\"flex flex-row items-start relative px-0 pb-0 fade md:overflow-auto scroll-pr-6 md:relative\",\"id\":\"nav\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex flex-row space-x-0 pr-10\",\"children\":[[\"$\",\"$Lb\",\"/\",{\"href\":\"/\",\"className\":\"transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1\",\"children\":\"home\"}],[\"$\",\"$Lb\",\"/about\",{\"href\":\"/about\",\"className\":\"transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1\",\"children\":\"about\"}],[\"$\",\"$Lb\",\"/blog\",{\"href\":\"/blog\",\"className\":\"transition-all hover:text-neutral-800 dark:hover:text-neutral-200 flex align-middle relative py-1 px-2 m-1\",\"children\":\"blog\"}]]}]}]}]}],[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"section\",null,{\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-8 text-2xl font-semibold tracking-tighter\",\"children\":\"404 - Page Not Found\"}],[\"$\",\"p\",null,{\"className\":\"mb-4\",\"children\":\"The page you are looking for does not exist.\"}]]}],\"notFoundStyles\":[]}],[\"$\",\"footer\",null,{\"className\":\"mb-16\",\"children\":[[\"$\",\"ul\",null,{\"className\":\"font-sm mt-8 flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300\",\"children\":[[\"$\",\"li\",null,{\"children\":[\"$undefined\",[\"$\",\"p\",null,{\"className\":\" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"children\":\"Corvallis, Oregon, USA\"}]]}],[\"$\",\"li\",null,{\"children\":[\"$undefined\",[\"$\",\"p\",null,{\"className\":\" h-7 flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"children\":\"Phone: 541-360-9231\"}]]}]]}],[\"$\",\"ul\",null,{\"className\":\"font-sm flex flex-col space-x-0 space-y-2 text-neutral-600 md:flex-row md:space-x-4 md:space-y-0 dark:text-neutral-300\",\"children\":[[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"className\":\"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"rel\":\"noopener noreferrer\",\"target\":\"_blank\",\"href\":\"https://github.com/bachsofttrick\",\"children\":[[\"$\",\"svg\",null,{\"width\":\"12\",\"height\":\"12\",\"viewBox\":\"0 0 12 12\",\"fill\":\"none\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z\",\"fill\":\"currentColor\"}]}],[\"$\",\"p\",null,{\"className\":\"ml-2 h-7\",\"children\":\"github\"}]]}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"className\":\"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"rel\":\"noopener noreferrer\",\"target\":\"_blank\",\"href\":\"https://github.com/bachsofttrick/bachsofttrick.github.io\",\"children\":[[\"$\",\"svg\",null,{\"width\":\"12\",\"height\":\"12\",\"viewBox\":\"0 0 12 12\",\"fill\":\"none\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z\",\"fill\":\"currentColor\"}]}],[\"$\",\"p\",null,{\"className\":\"ml-2 h-7\",\"children\":\"view source\"}]]}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"className\":\"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"rel\":\"noopener noreferrer\",\"target\":\"_blank\",\"href\":\"https://linkedin.com/in/brian-phan-58530b1b0/\",\"children\":[[\"$\",\"svg\",null,{\"width\":\"12\",\"height\":\"12\",\"viewBox\":\"0 0 12 12\",\"fill\":\"none\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z\",\"fill\":\"currentColor\"}]}],[\"$\",\"p\",null,{\"className\":\"ml-2 h-7\",\"children\":\"linkedin\"}]]}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"className\":\"flex items-center transition-all hover:text-neutral-800 dark:hover:text-neutral-100\",\"rel\":\"noopener noreferrer\",\"target\":\"_blank\",\"href\":\"mailto:xuanbach1307@gmail.com\",\"children\":[[\"$\",\"svg\",null,{\"width\":\"12\",\"height\":\"12\",\"viewBox\":\"0 0 12 12\",\"fill\":\"none\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"d\":\"M2.07102 11.3494L0.963068 10.2415L9.2017 1.98864H2.83807L2.85227 0.454545H11.8438V9.46023H10.2955L10.3097 3.09659L2.07102 11.3494Z\",\"fill\":\"currentColor\"}]}],[\"$\",\"p\",null,{\"className\":\"ml-2 h-7\",\"children\":\"email\"}]]}]}]]}],[\"$\",\"p\",null,{\"className\":\"mt-8 text-neutral-600 dark:text-neutral-300\",\"children\":2024}]]}]]}]}]}]],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$Lc\"],\"globalErrorComponent\":\"$d\",\"missingSlots\":\"$We\"}]\n"])</script><script>self.__next_f.push([1,"7:[[\"$\",\"p\",null,{\"children\":\"I am a media consumption enthusiast. Let's just say I watch movies a\\nlot. Usually, people like me will have a big home theater setup with a\\nlarge TV, a large speaker set, a media player with huge HDD storage. But\\nthat sounds like too much work, since you have to update the hard drive\\nconstantly with new catalogues. So I built my server out of an old i3\\nlaptop, a SSD, 2 HDD lying around with a dock and an Ethernet USB\\ndongle. I chose 2.5 Gbps dongle version because I wanted to future-proof\\nmy server. But that proved to be my undoing, because the OS I chose for\\nmy server, Debian, had an older version of the driver that didn't\\nsupport the RTL8156 chipset. It might support an older one, the RTL8153,\\nwhich is the 1 Gbps variant. So I searched for its driver. It's quite a\\nlittle adventure.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"p\",null,{\"className\":\"flex justify-center\",\"children\":[\"$\",\"img\",null,{\"src\":\"/images/blog/230504/DKMS_flow.webp\",\"alt\":\"\"}]}]}],\"\\n\",[\"$\",\"h4\",null,{\"id\":\"first-time-compiling-from-source\",\"className\":\"$undefined\",\"children\":[[[\"$\",\"a\",\"link-first-time-compiling-from-source\",{\"href\":\"#first-time-compiling-from-source\",\"className\":\"anchor\"}]],\"First time compiling from source\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"A Google search for RTL8156 driver for linux led me to the\\nmanufacturer's driver page to download the driver. However, the\\ncompressed file I downloaded (in this instance .tar.bz2) didn't have any\\n.deb file to install. Instead I was left with a bunch of .h, .c files\\nwith a Makefile. I thought: \\\"Wait. This is a source code!\\\".\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"So far, I have mostly installed apps and drivers through apt so this was\\na new territory. I did some researches and tried compiling the driver.\\nIn the source code folder, I typed:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"make -j4\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"With -j4 being number of jobs to run simultaneously, 4 is the number of\\nthreads of my CPU. After it finished, the result was r8152.ko file, a\\nkernel module. I plugged in the Ethernet USB. It didn't work. Then I\\ntried loading the module into the kernel like \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.tecmint.com/load-and-unload-kernel-modules-in-linux/\",\"children\":\"this\\narticle\"}],\"\\nsuggested:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"insmod r8152.ko\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Then it worked. My server recognized it.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"ip a\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"3: enx00e04e3b0ac0: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1500 qdisc\\npfifo_fast state UP mode DEFAULT group default qlen 1000\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"I edited the \",[\"$\",\"em\",null,{\"children\":\"interface\"}],\"s file in \",[\"$\",\"em\",null,{\"children\":\"/etc/network\"}],\" to assign it a static\\naddress by adding:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"allow-hotplug enx00e04e3b0ac0\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"iface enx00e04e3b0ac0 inet static\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"address 192.168.4.3/24\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"gateway 192.168.4.1\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"For then on, I could access my server in my house through that IP,\\n\",[\"$\",\"em\",null,{\"children\":\"192.168.4.3.\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"But I discovered that:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- At start-up, I have to \",[\"$\",\"em\",null,{\"children\":\"insmod\"}],\" like that to load the module. This\\nwas solved by simply copying that module to /lib/modules/$(uname\\n-r)/kernel/drivers/net/usb. Didn't have to \",[\"$\",\"em\",null,{\"children\":\"insmod\"}],\" anymore. But that\\nwasn't all.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"- Every time I update the server with apt update, apt upgrade, and\\nthere is a kernel update, I have to compile module from source, copy it\\nover again or else I lose the driver. So I often delay updating my\\nserver, which is bad because you want to keep your kernel up-to-date on\\nbugfix, vulnerabilities.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"I needed a way to make it compile every time there is a kernel update.\\nSo is there a way?\"}],\"\\n\",[\"$\",\"h4\",null,{\"id\":\"dkms-dynamic-kernel-module-support\",\"className\":\"$undefined\",\"children\":[[[\"$\",\"a\",\"link-dkms-dynamic-kernel-module-support\",{\"href\":\"#dkms-dynamic-kernel-module-support\",\"className\":\"anchor\"}]],\"dkms - Dynamic Kernel Module Support\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Nowadays, I use an Ubuntu desktop as my main driver. I often see\\nsomething along the line of dkms for my Nvidia card anytime there is a\\nkernel update. After rebooting, the video card still works with the new\\nkernel. Naturally, I started looking into this \\\"dkms\\\".\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"According to this \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://linuxhint.com/dkms-linux/\",\"children\":\"article\"}],\", dkms\\n\",[\"$\",\"em\",null,{\"children\":\"\\\"is a framework where device driver source can reside outside the\\nkernel source tree so that it is very easy to rebuild modules as you\\nupgrade kernels\\\"\"}],\". So this is the stuff I was looking for. The author\\nalso encountered dkms similarly to me, but by following guides to\\ninstall his Wifi driver.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"So with the source code of my Ethernet USB, I copied it to \",[\"$\",\"em\",null,{\"children\":\"/usr/src\"}],\". I\\nalso created a file inside the source code's folder, \",[\"$\",\"em\",null,{\"children\":\"dkms.conf\"}],\" with\\nthe following content:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PACKAGE_NAME=\\\"r8152\\\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"PACKAGE_VERSION=\\\"2.15.0\\\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"BUILT_MODULE_NAME[0]=\\\"r8152\\\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"MAKE=\\\"'make' -j$(nproc) KVER=${kernelver}\\\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"CLEAN=\\\"'make' clean\\\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"DEST_MODULE_LOCATION[0]=\\\"/kernel/drivers/net/usb/\\\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"AUTOINSTALL=\\\"YES\\\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"PACKAGE_NAME gives the name to the entire package of modules.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"PACKAGE_VERSION give the version of the entire package of modules being\\ninstalled with dkms. These two form the name of the folder that contains\\nthe source code, *r8152-2.15.0.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"BUILT_MODULE_NAME gives the name of the module just after it is built.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"DEST_MODULE_LOCATION specifies the destination where a module should\\nbe installed to, once compiled. From the example: /lib/modules/$(uname\\n-r)\",[\"$\",\"em\",null,{\"children\":\"/kernel/drivers/net/usb\"}],\".\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Note that for each module within a dkms package, the numeric value of #\\nmust be the same for each of BUILT_MODULE_NAME and\\nDEST_MODULE_LOCATION and that the numbering should start at 0. So each\\nmodule goes with its own destination\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"MAKE and CLEAN correspond to commands used to run when dkms builds\\n(make) the module and cleans up after.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"AUTOINSTALL is set to yes so that the service\\n/etc/rc.d/init.d/dkms_autoinstaller will automatically try to install\\nthis module when upgrading kernel.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"After that, I ran three commands:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- \",[\"$\",\"em\",null,{\"children\":\"sudo dkms add r8152/2.15.0\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- \",[\"$\",\"em\",null,{\"children\":\"sudo dkms build r8152/2.15.0\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- \",[\"$\",\"em\",null,{\"children\":\"sudo dkms install r8152/2.15.0\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"And it installed the driver to the kernel. From then on, it will build\\nand reinstall anytime I upgrade the kernel.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Result:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"sudo dkms add r8152/2.15.0\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"Creating symlink /var/lib/dkms/r8152/2.15.0/source -\u003e\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"/usr/src/r8152-2.15.0\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"DKMS: add completed.\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"sudo dkms build r8152/2.15.0\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"Kernel preparation unnecessary for this kernel. Skipping...\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"Building module:\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"cleaning build area...\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"'make' -j4 KVER=5.10.0-22-amd64......\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"cleaning build area...\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"DKMS: build completed.\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"sudo dkms install r8152/2.15.0\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"r8152.ko:\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"Running module version sanity check.\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"Good news! Module version v2.15.0 for r8152.ko\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"exactly matches what is already found in kernel 5.10.0-22-amd64.\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"DKMS will not replace this module.\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"You may override by specifying --force.\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"depmod....\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"DKMS: install completed.\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"dkms status\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"broadcom-sta, 6.30.223.271, 5.10.0-20-amd64, x86_64: installed\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"broadcom-sta, 6.30.223.271, 5.10.0-22-amd64, x86_64: installed\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"em\",null,{\"children\":\"[r8152, 2.15.0, 5.10.0-22-amd64, x86_64: installed]\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"If you wish to remove the driver, type in \",[\"$\",\"em\",null,{\"children\":\"\\\"dkms remove r8152/2.15.0\\n--all\\\"\"}],\".\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"References:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://linux.die.net/man/8/dkms\",\"children\":\"man dkms\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"- \",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://www.realtek.com/en/component/zoo/category/network-interface-controllers-10-100-1000m-gigabit-ethernet-usb-3-0-software\",\"children\":\"Realtek USB FE / GBE / 2.5G / Gaming Ethernet Family Controller\\nSoftware\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"-\\n\",[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://github.com/brektrou/rtl8821CU/blob/master/dkms-install.sh\",\"children\":\"rtl8821CU\"}]]}]]\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Auto build driver when updating Linux kernel with dkms | Brian Phan\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"This is my portfolio.\"}],[\"$\",\"meta\",\"4\",{\"name\":\"robots\",\"content\":\"index, follow\"}],[\"$\",\"meta\",\"5\",{\"name\":\"googlebot\",\"content\":\"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:title\",\"content\":\"My Portfolio\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:description\",\"content\":\"This is my portfolio.\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:url\",\"content\":\"https://bachsofttrick.github.io\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:site_name\",\"content\":\"My Portfolio\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:locale\",\"content\":\"en_US\"}],[\"$\",\"meta\",\"11\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"12\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:title\",\"content\":\"My Portfolio\"}],[\"$\",\"meta\",\"14\",{\"name\":\"twitter:description\",\"content\":\"This is my portfolio.\"}],[\"$\",\"meta\",\"15\",{\"name\":\"next-size-adjust\"}]]\n6:null\n"])</script></body></html>